import{ao as $,p as F,j as e,q as G,r as l,al as z,c as A,av as _}from"./vendor-obEwBfia.js";import{g as T,f as q,s as H,p as k,d as K,b as V,M as X,E as v,c as I,I as M,a as P,P as R,B as E,L as Y,e as J,u as Q,h as Z,i as ee,j as S,k as te,l as B,m as ne,n as re,o as ae,q as se,r as ie,t as ce,v as oe,w as de,x as ue,y as le,z as C,A as me}from"./index-LKd9rWQ7.js";import{a as b,I as O}from"./Icons--uG9Na6u.js";import{b as D,a as pe,e as he,l as fe}from"./react-dom-75QGQ8x8.js";import"./auth-PrcDRVv8.js";import"./caption-parsing-RO8mGNwK.js";import"./locales-kG0Ihi24.js";import"./hls-zqvr_1ex.js";import"./ietf-language-tags-EHt6_2CE.js";function ge(t,r){return!!J().DISALLOWED_IDS.map(a=>a.split("-")).find(a=>t===a[1]&&r===a[0])}function xe(t){const{t:r}=D(),i=$(),a=F(),{error:u,value:p,loading:c}=pe(async()=>{var w;const f=T();f?await q(f):H([...k.listSources(),...k.listEmbeds()]);let o=null;try{if(!i.media)throw new Error("no media params");o=K(i.media)}catch{}if(!o)return null;if(ge(o.id,o.type))throw new Error("dmca");let x=null;try{x=await V(o.type,o.id,i.season)}catch(h){if(h.status===404)return null;throw h}if(!x)return null;let g=i.episode;if(x.meta.type===X.SERIES){let h=x.meta.seasonData.episodes.find(s=>s.id===i.episode);h||(h=x.meta.seasonData.episodes[0]),g=h.id,(i.season!==x.meta.seasonData.id||i.episode!==h.id)&&a(`/media/${i.media}/${x.meta.seasonData.id}/${h.id}`,{replace:!0})}(w=t.onGetMeta)==null||w.call(t,x,g)},[]);return u&&u.message==="dmca"?e.jsx(v,{children:e.jsxs(I,{children:[e.jsx(M,{icon:b.DRAGON,children:"Removed"}),e.jsx(P,{children:"Media has been removed"}),e.jsx(R,{children:"This media is no longer available due to a takedown notice or copyright claim."}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.metadata.failed.homeButton")})]})}):u?e.jsx(v,{children:e.jsxs(I,{children:[e.jsx(M,{icon:b.WAND,children:r("player.metadata.failed.badge")}),e.jsx(P,{children:r("player.metadata.failed.title")}),e.jsx(R,{children:r("player.metadata.failed.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.metadata.failed.homeButton")})]})}):!p&&!c?e.jsx(v,{children:e.jsxs(I,{children:[e.jsx(M,{icon:b.WAND,children:r("player.metadata.notFound.badge")}),e.jsx(P,{children:r("player.metadata.notFound.title")}),e.jsx(R,{children:r("player.metadata.notFound.text")}),e.jsx(E,{href:"/",theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.metadata.notFound.homeButton")})]})}):e.jsx(v,{children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(Y,{})})})}function ye(t){const{t:r}=D(),i=Q("error"),a=G(),u=l.useMemo(()=>{const p=t.data;let c="";const f=Z();return c+=`URL - ${a.pathname}
`,c+=`API - ${f.length>0}

`,Object.values(p.sources).forEach(o=>{c+=`${o.id}: ${o.status}
`,o.reason&&(c+=`${o.reason}
`),o.error&&(c+=`${o.error.toString()}
`)}),c},[t,a]);return e.jsxs(v,{children:[e.jsxs(I,{children:[e.jsx(M,{icon:b.WAND,children:r("player.scraping.notFound.badge")}),e.jsx(P,{children:r("player.scraping.notFound.title")}),e.jsx(R,{children:r("player.scraping.notFound.text")}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(E,{href:"/",theme:"secondary",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.scraping.notFound.homeButton")}),e.jsx(E,{onClick:()=>i.show(),theme:"purple",padding:"md:px-12 p-2.5",className:"mt-6",children:r("player.scraping.notFound.detailsButton")})]})]}),u?e.jsx(ee,{id:i.id,onClose:()=>i.hide(),error:u}):null]})}function L(t){return t.type==="loading"}function je(t){const[r]=z(()=>({percentage:L(t)?t.percentage:0}),[t]);return e.jsxs("div",{className:A({"p-0.5 border-current border-[3px] rounded-full h-6 w-6 relative transition-colors":!0,"text-video-scraping-loading":t.type==="loading","text-video-scraping-noresult text-opacity-50":t.type==="waiting","text-video-scraping-error bg-video-scraping-error":t.type==="error","text-green-500 bg-green-500":t.type==="success","text-video-scraping-noresult bg-video-scraping-noresult":t.type==="noresult"}),children:[e.jsx(S,{animation:"fade",show:L(t),children:e.jsx("svg",{width:"100%",height:"100%",viewBox:"0 0 64 64",xmlns:"http://www.w3.org/2000/svg",className:"rounded-full -rotate-90",children:e.jsx(he.circle,{strokeWidth:"32",strokeDasharray:_(r.percentage,i=>`${i} 100`),r:"25%",cx:"50%",cy:"50%",fill:"transparent",stroke:"currentColor",className:"transition-[strokeDasharray]"})})}),e.jsx(S,{animation:"fade",show:t.type==="error",children:e.jsx(O,{className:"absolute inset-0 flex items-center justify-center text-white",icon:b.X})}),e.jsx(S,{animation:"fade",show:t.type==="success",children:e.jsx(O,{className:"absolute inset-0 flex items-center text-xs justify-center text-white",icon:b.CHECKMARK})}),e.jsx(S,{animation:"fade",show:t.type==="noresult",children:e.jsx("div",{className:"absolute inset-0 flex items-center",children:e.jsx("div",{className:"h-[3px] flex-1 mx-1 rounded-full bg-background-main"})})})]})}const we={notfound:"player.scraping.items.notFound",failure:"player.scraping.items.failure",pending:"player.scraping.items.pending"},be={failure:"error",notfound:"noresult",pending:"loading",success:"success",waiting:"waiting"};function U(t){const{t:r}=D(),i=we[t.status],a=be[t.status];return e.jsxs("div",{className:"grid gap-4 grid-cols-[auto,1fr]","data-source-id":t.id,children:[e.jsx(je,{type:a,percentage:t.percentage??0}),e.jsxs("div",{children:[e.jsx("p",{className:a==="loading"?"text-white":"text-type-secondary",children:t.name}),e.jsx(S,{animation:"fade",show:!!i,children:e.jsx("p",{className:"text-[15px] mt-1",children:i?r(i):""})}),t.children]})]})}function ve(t){return e.jsx("div",{"data-source-id":t.id,className:"w-80 mb-6",children:e.jsx("div",{className:A({"!bg-opacity-100 py-6":t.hasChildren,"w-80 rounded-md px-6 bg-video-scraping-card bg-opacity-0":!0}),children:e.jsx(U,{...t})})})}function Se(){const[t,r]=l.useState({}),[i,a]=l.useState([]),[u,p]=l.useState(),c=l.useRef(null),f=l.useCallback(s=>{r(s.sourceIds.map(n=>{const d=B().find(m=>m.id===n);if(!d)throw new Error("invalid source id");return{name:d.name,id:d.id,status:"waiting",percentage:0}}).reduce((n,d)=>(n[d.id]=d,n),{})),a(s.sourceIds.map(n=>({id:n,children:[]})))},[]),o=l.useCallback(s=>{r(n=>(n[s]&&(n[s].status="pending"),{...n})),p(s),c.current=s},[]),x=l.useCallback(s=>{r(n=>(n[s.id]&&(n[s.id].status=s.status,n[s.id].reason=s.reason,n[s.id].error=s.error,n[s.id].percentage=s.percentage),{...n}))},[]),g=l.useCallback(s=>{r(n=>(s.embeds.forEach(d=>{const y=B().find(j=>j.id===d.embedScraperId);if(!y)throw new Error("invalid source id");const m={embedId:d.embedScraperId,name:y.name,id:d.id,status:"waiting",percentage:0};n[d.id]=m}),{...n})),a(n=>{const d=n.find(y=>y.id===s.sourceId);if(!d)throw new Error("invalid source id");return d.children=s.embeds.map(y=>y.id),[...n]})},[]),w=l.useCallback(()=>{c.current=null},[]),h=l.useCallback(s=>(s&&c.current&&r(n=>c.current?(n[c.current]&&(n[c.current].status="success"),{...n}):n),s),[]);return{initEvent:f,startEvent:o,updateEvent:x,discoverEmbedsEvent:g,startScrape:w,getResult:h,sources:t,sourceOrder:i,currentSource:u}}function Ee(){const{sources:t,sourceOrder:r,currentSource:i,updateEvent:a,discoverEmbedsEvent:u,initEvent:p,getResult:c,startEvent:f,startScrape:o}=Se();return{startScraping:l.useCallback(async g=>{const w=T();if(w){o();const s=ne(w),n=await te(s.scrapeAll(g),["completed","noOutput"]);n.on("init",p),n.on("start",f),n.on("update",a),n.on("discoverEmbeds",u);const d=await n.promise();return c(d===""?null:d)}if(!k)return null;o();const h=await k.runAll({media:g,events:{init:p,start:f,update:a,discoverEmbeds:u}});return c(h)},[p,f,a,u,c,o]),sourceOrder:r,sources:t,currentSource:i}}function Ne(t,r,i,a){const[u,p]=l.useState(!1),c=l.useCallback(()=>{if(!t.current||!r.current)return;const o=[...r.current.querySelectorAll("div[data-source-id]")],x=o.findIndex(W=>W.getAttribute("data-source-id")===a),g=o[x];if(!g)return;const w=t.current.getBoundingClientRect().width,h=r.current.getBoundingClientRect().width,s=t.current.getBoundingClientRect().height,n=r.current.getBoundingClientRect().top,d=g.getBoundingClientRect().top,y=g.getBoundingClientRect().height,m=d-n,j=w/2-h/2,N=s/2-m-y/2;r.current.style.transform=`translateY(${N}px) translateX(${j}px)`,setTimeout(()=>{p(!0)},150)},[a,t,r,p]),f=l.useRef(c);return l.useEffect(()=>{c(),f.current=c},[c,i]),l.useEffect(()=>{function o(){f.current()}return window.addEventListener("resize",o),()=>{window.removeEventListener("resize",o)}},[]),u}function Ce(t){const{report:r}=re(),{startScraping:i,sourceOrder:a,sources:u,currentSource:p}=Ee(),c=fe(),f=l.useRef(null),o=l.useRef(null),x=Ne(f,o,a,p),g=l.useRef({sourceOrder:a,sources:u});l.useEffect(()=>{g.current={sourceOrder:a,sources:u}},[a,u]);const w=l.useRef(!1);l.useEffect(()=>{w.current||(w.current=!0,(async()=>{var d,y;const n=await i(t.media);c()&&((d=t.onResult)==null||d.call(t,g.current.sources,g.current.sourceOrder),r(ae(t.media,g.current.sourceOrder,g.current.sources)),(y=t.onGetStream)==null||y.call(t,n))})())},[i,t,r,c]);const h=a.find(n=>u[n.id].status==="pending");let s=a.findIndex(n=>(h==null?void 0:h.id)===n.id);return s===-1&&(s=a.length-1),e.jsx("div",{className:"h-full w-full relative dir-neutral:origin-top-left flex",ref:f,children:e.jsx("div",{className:A({"absolute transition-[transform,opacity] opacity-0 dir-neutral:left-0":!0,"!opacity-100":x}),ref:o,children:a.map(n=>{const d=u[n.id],y=Math.abs(a.findIndex(m=>m.id===n.id)-s);return e.jsx("div",{className:"transition-opacity duration-100",style:{opacity:Math.max(0,1-y*.3)},children:e.jsx(ve,{id:n.id,name:d.name,status:d.status,hasChildren:n.children.length>0,percentage:d.percentage,children:e.jsx("div",{className:A({"space-y-6 mt-8":n.children.length>0}),children:n.children.map(m=>{const j=u[m];return e.jsx(U,{id:m,name:j.name,status:j.status,percentage:j.percentage},m)})})})},n.id)})})})}function Ie(t){const r=t??"";if(!!!r.match(/^\d+(:\d+)*$/))return null;const a=r.split(":").map(Number).reverse(),u=a[2]??0,p=Math.min(a[1]??0,59),c=Math.min(a[0]??0,p>0?59:1/0);return u*60*60+p*60+c}function $e(){const t=F(),r=$(),[i,a]=l.useState(null),[u]=se("t"),{status:p,playMedia:c,reset:f,setScrapeNotFound:o,shouldStartFromBeginning:x,setShouldStartFromBeginning:g}=ie(),{setPlayerMeta:w,scrapeMedia:h}=ce(),s=oe(),n=JSON.stringify({media:r.media,season:r.season,episode:r.episode});l.useEffect(()=>{f()},[n,f]);const d=l.useCallback(m=>{var j,N;(m==null?void 0:m.type)==="show"?t(`/media/${r.media}/${(j=m.season)==null?void 0:j.tmdbId}/${(N=m.episode)==null?void 0:N.tmdbId}`):t(`/media/${r.media}`)},[t,r]),y=l.useCallback(m=>{if(!m)return;let j;u&&(j=Ie(u)??void 0),c(de(m),ue(m.stream.captions),m.sourceId,x?0:j),g(!1)},[c,u,x,g]);return e.jsxs(le,{backUrl:s,onMetaChange:d,children:[p===C.IDLE?e.jsx(xe,{onGetMeta:w}):null,p===C.SCRAPING&&h?e.jsx(Ce,{media:h,onResult:(m,j)=>{a({sourceOrder:j,sources:m}),o()},onGetStream:y}):null,p===C.SCRAPE_NOT_FOUND&&i?e.jsx(ye,{data:i}):null,p===C.PLAYBACK_ERROR?e.jsx(me,{}):null]})}export{$e as PlayerView,$e as default};
//# sourceMappingURL=PlayerView-6nGF7bBv.js.map
